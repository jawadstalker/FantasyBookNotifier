<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fantasy Book Notifier - Character Extractor + Summarizer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .char-box {
      height: 180px;
      resize: none;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">

    <!-- SUBSCRIBE SECTION -->
    <div class="row justify-content-center mb-5">
      <div class="col-md-8 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h3 class="card-title mb-3">Subscribe for fantasy book updates</h3>
            <form id="subscribeForm">
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" placeholder="you@example.com" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Choose publishers</label>
                <div id="publishersList" class="form-check">Loading publishers...</div>
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-primary">Subscribe</button>
              </div>
              <div id="message" class="mt-3" role="status" aria-live="polite"></div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- CHARACTER EXTRACTION & SUMMARIZATION SECTION -->
    <div class="row justify-content-center">
      <div class="col-md-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <h3 class="card-title mb-3">Character Name Extractor & Text Summarizer</h3>

            <div class="row g-3">
              <!-- Input -->
              <div class="col-md-4">
                <label class="form-label">Input Text</label>
                <textarea id="inputText" class="form-control char-box" placeholder="Paste story text here..."></textarea>
              </div>

              <!-- Extracted Names -->
              <div class="col-md-4">
                <label class="form-label">Extracted Names</label>
                <textarea id="outputNames" class="form-control char-box" readonly placeholder="Names will appear here..."></textarea>
              </div>

              <!-- Summary -->
              <div class="col-md-4">
                <label class="form-label">Summary</label>
                <textarea id="outputSummary" class="form-control char-box" readonly placeholder="Summary will appear here..."></textarea>
              </div>
            </div>

            <div class="d-grid gap-2 mt-3">
              <button class="btn btn-dark" onclick="extractNames()">Extract Names</button>
              <button class="btn btn-secondary" onclick="summarizeText()">Summarize Text</button>
            </div>

            <div id="extractMessage" class="mt-2"></div>
            <div id="summaryMessage" class="mt-2"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
/* ---------------- LOAD PUBLISHERS ---------------- */
async function loadPublishers() {
  try {
    const res = await fetch('/publishers');
    const data = await res.json();
    const cont = document.getElementById('publishersList');
    cont.innerHTML = '';
    const pubs = data.publishers || [];
    pubs.forEach((p, idx) => {
      const id = 'pub_' + idx;
      const div = document.createElement('div');
      div.className = 'form-check';
      div.innerHTML = `
        <input class="form-check-input" type="checkbox" value="${p}" id="${id}">
        <label class="form-check-label" for="${id}">${p}</label>`;
      cont.appendChild(div);
    });
    if (pubs.length === 0) cont.innerText = 'No publishers available.';
  } catch (err) {
    console.error(err);
    document.getElementById('publishersList').innerText = 'Failed to load publishers.';
  }
}

loadPublishers();

/* ---------------- SUBSCRIBE FORM ---------------- */
const form = document.getElementById('subscribeForm');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('email').value.trim();
  const checked = Array.from(document.querySelectorAll('#publishersList input[type=checkbox]:checked')).map(cb => cb.value);

  if (!email) { showMessage('Please enter a valid email.', 'danger'); return; }
  if (checked.length === 0) { showMessage('Please select at least one publisher.', 'danger'); return; }

  showMessage('Sending subscription...','info');

  try {
    const res = await fetch('/subscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, publishers: checked })
    });
    const data = await res.json();
    if (res.ok) showMessage(data.message || 'Subscribed successfully!', 'success');
    else showMessage(data.error || 'Subscription failed', 'danger');
  } catch (err) {
    console.error(err);
    showMessage('Network error: could not reach server.', 'danger');
  }
});

function showMessage(text, type) {
  const el = document.getElementById('message');
  const cls = type === 'success' ? 'alert alert-success'
            : type === 'danger' ? 'alert alert-danger'
            : 'alert alert-secondary';
  el.className = cls;
  el.textContent = text;
}

/* ---------------- CHARACTER EXTRACTOR ---------------- */
async function extractNames() {
  const text = document.getElementById("inputText").value.trim();
  const out = document.getElementById("outputNames");
  const msg = document.getElementById("extractMessage");

  if (!text) {
    msg.innerHTML = `<div class="alert alert-danger">Please enter some text.</div>`;
    return;
  }

  msg.innerHTML = `<div class="alert alert-info">Processing...</div>`;

  try {
    const res = await fetch("/extract-names", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ text })
    });

    const data = await res.json();

    if (data.error) {
      msg.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
      out.value = "";
    } else {
      msg.innerHTML = `<div class="alert alert-success">Done!</div>`;
      out.value = data.names.join("\n");
    }
  } catch (err) {
    msg.innerHTML = `<div class="alert alert-danger">Server error.</div>`;
    out.value = "";
  }
}

/* ---------------- SUMMARIZE TEXT ---------------- */
async function summarizeText() {
  const text = document.getElementById("inputText").value.trim();
  const out = document.getElementById("outputSummary");
  const msg = document.getElementById("summaryMessage");

  if (!text) {
    msg.innerHTML = `<div class="alert alert-danger">Please enter some text.</div>`;
    return;
  }

  msg.innerHTML = `<div class="alert alert-info">Generating summary...</div>`;

  try {
    const res = await fetch("/summarize", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ text })
    });

    const data = await res.json();

    if (data.error) {
      msg.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
      out.value = "";
    } else {
      msg.innerHTML = `<div class="alert alert-success">Summary ready!</div>`;
      out.value = data.summary;
    }
  } catch (err) {
    msg.innerHTML = `<div class="alert alert-danger">Server error.</div>`;
    out.value = "";
  }
}
</script>

</body>
</html>
